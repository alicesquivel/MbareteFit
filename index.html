<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MbareteFit Firebase Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase setup -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f8fafc; color: #222; }
        .container { max-width: 400px; margin: 2rem auto; background: #fff; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 12px #0001; }
        input, button { width: 100%; margin: 0.5rem 0; padding: 0.5rem; }
        #logout { margin-top: 1rem; }
        #chartContainer { margin: 2rem auto; max-width: 600px; }
    </style>
</head>
<body>
<div class="container" id="auth-container">
    <h2>Sign Up / Login</h2>
    <input type="email" id="email" placeholder="Email" autocomplete="username">
    <input type="password" id="password" placeholder="Password" autocomplete="current-password">
    <button id="loginBtn">Login / Sign Up</button>
    <p id="auth-msg"></p>
</div>

<div class="container" id="app-container" style="display:none;">
    <h2>MbareteFit</h2>
    <div>
        <label>Weight (kg): <input type="number" id="weight-input" min="1" step="0.1"></label>
        <button id="log-weight-btn">Log Weight</button>
    </div>
    <div>
        <h3>History</h3>
        <ul id="history"></ul>
    </div>
    <button id="logout">Logout</button>
</div>

<div id="chartContainer" style="display:none;">
    <canvas id="weightChart"></canvas>
</div>

<script>
    // ==== 1. YOUR FIREBASE CONFIG HERE ====
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
        projectId: "YOUR_PROJECT_ID",
        appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ==== 2. UI ELEMENTS ====
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const chartContainer = document.getElementById('chartContainer');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const authMsg = document.getElementById('auth-msg');
    const logoutBtn = document.getElementById('logout');
    const weightInput = document.getElementById('weight-input');
    const logWeightBtn = document.getElementById('log-weight-btn');
    const historyEl = document.getElementById('history');
    const weightChartCanvas = document.getElementById('weightChart');
    let weightChart = null;

    // ==== 3. AUTH HANDLERS ====
    loginBtn.onclick = async () => {
        const email = emailInput.value;
        const pass = passwordInput.value;
        authMsg.textContent = '';
        try {
            await auth.signInWithEmailAndPassword(email, pass);
        } catch (e) {
            if (e.code === 'auth/user-not-found') {
                // Try to create user
                try {
                    await auth.createUserWithEmailAndPassword(email, pass);
                } catch (err) {
                    authMsg.textContent = err.message;
                }
            } else {
                authMsg.textContent = e.message;
            }
        }
    };

    logoutBtn.onclick = () => auth.signOut();

    // ==== 4. APP STATE ====
    let userId = null;
    let userWeights = [];

    // ==== 5. APP LOGIC ====
    function showApp(loggedIn) {
        authContainer.style.display = loggedIn ? 'none' : '';
        appContainer.style.display = loggedIn ? '' : 'none';
        chartContainer.style.display = loggedIn ? '' : 'none';
    }

    function renderHistory() {
        historyEl.innerHTML = '';
        userWeights.slice().reverse().forEach(entry => {
            const li = document.createElement('li');
            li.textContent = `${entry.date}: ${entry.weight} kg`;
            historyEl.appendChild(li);
        });
    }

    function renderChart() {
        const labels = userWeights.map(e => e.date);
        const data = userWeights.map(e => e.weight);

        if (weightChart) weightChart.destroy();
        weightChart = new Chart(weightChartCanvas, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: "Weight (kg)",
                    data,
                    borderColor: "#3b82f6",
                    backgroundColor: "rgba(59,130,246,0.1)",
                    fill: true,
                    tension: 0.2,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { title: { display: true, text: "Date" } },
                    y: { title: { display: true, text: "Weight (kg)" } }
                }
            }
        });
    }

    logWeightBtn.onclick = async () => {
        const weight = parseFloat(weightInput.value);
        if (!weight || weight <= 0) return alert("Enter a valid weight.");
        const date = new Date().toISOString().slice(0,10);
        const newEntry = { date, weight };
        await db.ref('users/' + userId + '/weights').push(newEntry);
        weightInput.value = '';
    };

    function listenForWeights() {
        db.ref('users/' + userId + '/weights').on('value', snapshot => {
            const data = snapshot.val() || {};
            userWeights = Object.values(data).sort((a, b) => a.date.localeCompare(b.date));
            renderHistory();
            renderChart();
        });
    }

    // ==== 6. AUTH STATE LISTENER ====
    auth.onAuthStateChanged(user => {
        if (user) {
            userId = user.uid;
            showApp(true);
            listenForWeights();
        } else {
            showApp(false);
            if (weightChart) weightChart.destroy();
        }
    });
</script>
</body>
</html>
