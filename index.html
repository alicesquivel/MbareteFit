<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Weight Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Date Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Confetti.js for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .new-entry-animation { animation: slideIn 0.5s ease-out forwards; }

        @keyframes flash { 0% { background-color: transparent; } 50% { background-color: #dbeafe; } 100% { background-color: transparent; } }
        .flash-update { animation: flash 0.8s ease-out; }

        .profile-dropdown { display: none; }
        .profile-switcher:hover .profile-dropdown { display: block; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Main Container -->
    <div class="container mx-auto max-w-5xl p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">MbareteFit</h1>
            <p class="text-slate-600 mt-2">Your comprehensive tool for tracking weight, BMI, and progress.</p>
        </header>

        <!-- Top Controls -->
        <div class="flex justify-between items-center mb-6 gap-4">
            <!-- Profile Switcher -->
            <div id="profile-switcher-container" class="relative profile-switcher">
                <button id="current-profile-btn" class="flex items-center gap-2 bg-white border border-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                    <span id="current-profile-name">No Profile</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
                <div id="profile-dropdown" class="profile-dropdown absolute left-0 mt-2 w-56 bg-white rounded-md shadow-lg z-20">
                    <div id="profile-list" class="py-1"></div>
                    <div class="border-t border-slate-200">
                        <button id="add-profile-btn" class="block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Add New Profile</button>
                        <button id="manage-profiles-btn" class="block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Manage Profiles</button>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="flex items-center bg-slate-200 rounded-full p-1">
                    <button id="unit-kg-btn" class="px-4 py-1 rounded-full text-sm font-semibold">kg</button>
                    <button id="unit-lbs-btn" class="px-4 py-1 rounded-full text-sm font-semibold">lbs</button>
                </div>
                <button id="export-btn" class="bg-white border border-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-100 transition text-sm">Export</button>
                <button id="import-btn" class="bg-white border border-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-100 transition text-sm">Import</button>
                <input type="file" id="import-file" class="hidden" accept=".json">
            </div>
        </div>

        <main id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8 opacity-20 pointer-events-none">
            <!-- Left Column -->
            <div class="lg:col-span-1 space-y-8">
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Log New Entry</h2>
                    <div class="space-y-4">
                        <div class="relative"><input type="number" id="weight-input" placeholder="Enter weight" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"><span id="input-unit-label" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">kg</span></div>
                        <textarea id="notes-input" placeholder="Add a note (optional)" rows="2" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        <button id="log-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transform hover:scale-105 transition">Log Weight</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Your Progress</h2>
                    <div id="stats-container" class="space-y-3 text-sm">
                        <div class="mb-4"><span class="text-slate-600">Progress to Goal</span><div class="w-full bg-slate-200 rounded-full h-2.5 mt-1"><div id="goal-progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div></div></div>
                        <div class="flex justify-between items-baseline p-1 rounded-md"><span class="text-slate-600">Current:</span><span id="current-weight" class="text-xl font-bold text-slate-900">--</span></div>
                        <div class="flex justify-between items-baseline p-1 rounded-md"><span class="text-slate-600">Goal:</span><span id="goal-weight" class="text-xl font-bold text-blue-600">--</span></div>
                        <div class="flex justify-between items-baseline p-1 rounded-md"><span class="text-slate-600">Change:</span><span id="weight-change" class="text-xl font-bold text-green-600">--</span></div>
                        <hr class="my-2"><div class="flex justify-between items-baseline p-1 rounded-md"><span class="text-slate-600">BMI:</span><span id="bmi-stat" class="text-xl font-bold text-slate-900">--</span></div>
                        <div class="flex justify-between items-baseline p-1 rounded-md"><span class="text-slate-600">7-Day Avg:</span><span id="weekly-avg-stat" class="text-xl font-bold text-slate-900">--</span></div>
                        <div class="flex justify-between items-baseline p-1 rounded-md"><span class="text-slate-600">30-Day Avg:</span><span id="monthly-avg-stat" class="text-xl font-bold text-slate-900">--</span></div>
                        <hr class="my-2"><div class="flex justify-between items-baseline p-1 rounded-md"><span class="text-slate-600">Lowest:</span><span id="lowest-weight-stat" class="text-xl font-bold text-slate-900">--</span></div>
                        <div class="flex justify-between items-baseline p-1 rounded-md"><span class="text-slate-600">Highest:</span><span id="highest-weight-stat" class="text-xl font-bold text-slate-900">--</span></div>
                        <div class="grid grid-cols-2 gap-2 pt-4"><button id="edit-goal-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Goal</button><button id="edit-height-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Height</button></div>
                    </div>
                </div>
            </div>
            <!-- Right Column -->
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white p-6 rounded-2xl shadow-md relative min-h-[300px]"><h2 class="text-xl font-semibold mb-4">Progress Chart</h2><canvas id="weight-chart"></canvas><div id="chart-empty-state" class="absolute inset-0 flex-col items-center justify-center text-center text-slate-500 hidden"><svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg><p>Log your first weight to see your chart!</p></div></div>
                <div class="bg-white p-6 rounded-2xl shadow-md relative min-h-[300px]"><h2 class="text-xl font-semibold mb-4">History</h2><div id="history-container" class="max-h-96 overflow-y-auto custom-scrollbar"><table class="w-full text-left text-sm"><thead><tr><th class="py-2 px-4 bg-slate-100 rounded-l-lg">Date & Time</th><th class="py-2 px-4 bg-slate-100">Weight</th><th class="py-2 px-4 bg-slate-100">Notes</th><th class="py-2 px-4 bg-slate-100 rounded-r-lg"></th></tr></thead><tbody id="history-body"></tbody></table></div><div id="history-empty-state" class="absolute inset-0 flex-col items-center justify-center text-center text-slate-500 hidden"><svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg><p>Your entries will appear here.</p></div></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="profile-modal" class="fixed inset-0 z-50 items-center justify-center modal-backdrop hidden"><div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm m-4"><h2 class="text-2xl font-bold mb-4">Create Profile</h2><div class="space-y-4"><input type="text" id="profile-input" placeholder="Profile Name" class="w-full px-4 py-2 border rounded-lg"><input type="password" id="profile-password-input" placeholder="Password" class="w-full px-4 py-2 border rounded-lg"><input type="password" id="profile-confirm-password-input" placeholder="Confirm Password" class="w-full px-4 py-2 border rounded-lg"></div><div class="mt-6 flex justify-end"><button id="create-profile-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg">Create</button></div></div></div>
    <div id="login-modal" class="fixed inset-0 z-50 items-center justify-center modal-backdrop hidden"><div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm m-4"><h2 class="text-2xl font-bold mb-4">Login to <span id="login-profile-name"></span></h2><input type="password" id="login-password-input" placeholder="Password" class="w-full px-4 py-2 border rounded-lg"><div class="mt-6 flex justify-end"><button id="login-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg">Login</button></div></div></div>
    <div id="manage-profiles-modal" class="fixed inset-0 z-50 items-center justify-center modal-backdrop hidden"><div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md m-4"><h2 class="text-2xl font-bold mb-4">Manage Profiles</h2><div id="manage-profile-list" class="space-y-2"></div><div class="mt-6 flex justify-end"><button id="close-manage-profiles-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg">Close</button></div></div></div>
    <div id="goal-modal" class="fixed inset-0 z-50 items-center justify-center modal-backdrop hidden"><div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm m-4"><h2 class="text-2xl font-bold mb-4">Set Your Goal Weight</h2><input type="number" id="goal-input" placeholder="Enter goal weight" class="w-full px-4 py-2 border rounded-lg"><div class="mt-6 flex justify-end"><button id="set-goal-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg">Set Goal</button></div></div></div>
    <div id="height-modal" class="fixed inset-0 z-50 items-center justify-center modal-backdrop hidden"><div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm m-4"><h2 class="text-2xl font-bold mb-4">Set Your Height</h2><p class="text-slate-600 mb-6">Enter height in cm for BMI calculation.</p><input type="number" id="height-input" placeholder="Enter height in cm" class="w-full px-4 py-2 border rounded-lg"><div class="mt-6 flex justify-end"><button id="set-height-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg">Set Height</button></div></div></div>
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 items-center justify-center modal-backdrop hidden"><div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm m-4"><h2 class="text-2xl font-bold mb-2">Delete Entry?</h2><p class="text-slate-600 mb-6">This action cannot be undone.</p><div class="flex justify-end gap-4"><button id="cancel-delete-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg">Cancel</button><button id="confirm-delete-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg">Delete</button></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const allDOMElements = {
                mainContent: document.getElementById('main-content'),
                weightInput: document.getElementById('weight-input'), notesInput: document.getElementById('notes-input'), logBtn: document.getElementById('log-btn'),
                editGoalBtn: document.getElementById('edit-goal-btn'), editHeightBtn: document.getElementById('edit-height-btn'),
                currentWeightEl: document.getElementById('current-weight'), goalWeightEl: document.getElementById('goal-weight'),
                weightChangeEl: document.getElementById('weight-change'), bmiStatEl: document.getElementById('bmi-stat'),
                weeklyAvgEl: document.getElementById('weekly-avg-stat'), monthlyAvgEl: document.getElementById('monthly-avg-stat'),
                lowestWeightStatEl: document.getElementById('lowest-weight-stat'), highestWeightStatEl: document.getElementById('highest-weight-stat'),
                historyBody: document.getElementById('history-body'), chartCanvas: document.getElementById('weight-chart'),
                goalModal: document.getElementById('goal-modal'), goalInput: document.getElementById('goal-input'), setGoalBtn: document.getElementById('set-goal-btn'),
                heightModal: document.getElementById('height-modal'), heightInput: document.getElementById('height-input'), setHeightBtn: document.getElementById('set-height-btn'),
                unitKgBtn: document.getElementById('unit-kg-btn'), unitLbsBtn: document.getElementById('unit-lbs-btn'),
                inputUnitLabel: document.getElementById('input-unit-label'), exportBtn: document.getElementById('export-btn'),
                importBtn: document.getElementById('import-btn'), importFile: document.getElementById('import-file'),
                goalProgressBar: document.getElementById('goal-progress-bar'), chartEmptyState: document.getElementById('chart-empty-state'),
                historyEmptyState: document.getElementById('history-empty-state'), historyContainer: document.getElementById('history-container'),
                deleteConfirmModal: document.getElementById('delete-confirm-modal'), cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
                confirmDeleteBtn: document.getElementById('confirm-delete-btn'), profileModal: document.getElementById('profile-modal'),
                profileInput: document.getElementById('profile-input'), profilePasswordInput: document.getElementById('profile-password-input'),
                profileConfirmPasswordInput: document.getElementById('profile-confirm-password-input'), createProfileBtn: document.getElementById('create-profile-btn'),
                currentProfileName: document.getElementById('current-profile-name'), profileList: document.getElementById('profile-list'),
                addProfileBtn: document.getElementById('add-profile-btn'), manageProfilesBtn: document.getElementById('manage-profiles-btn'),
                loginModal: document.getElementById('login-modal'), loginProfileName: document.getElementById('login-profile-name'),
                loginPasswordInput: document.getElementById('login-password-input'), loginBtn: document.getElementById('login-btn'),
                manageProfilesModal: document.getElementById('manage-profiles-modal'), manageProfileList: document.getElementById('manage-profile-list'),
                closeManageProfilesBtn: document.getElementById('close-manage-profiles-btn'),
            };

            // App State
            let appData = {}; let activeProfile = null; let weightData = [], goalWeight, height, units;
            let weightChart; let entryToDelete = null; let profileToLogin = null;
            const KG_TO_LBS = 2.20462;

            // --- Utility & Crypto Functions ---
            const convertToKg = (val) => (units === 'lbs' ? val / KG_TO_LBS : val);
            const convertFromKg = (val) => (units === 'lbs' ? val * KG_TO_LBS : val);
            const formatWeight = (val) => val ? `${convertFromKg(val).toFixed(1)} ${units}` : '--';
            const calculateBMI = (weightKg, heightM) => (heightM > 0 && weightKg > 0 ? (weightKg / (heightM * heightM)).toFixed(1) : '--');
            const getBmiColor = (bmi) => { if (bmi < 18.5) return 'text-blue-500'; if (bmi < 25) return 'text-green-500'; if (bmi < 30) return 'text-yellow-500'; if (bmi < 35) return 'text-orange-500'; return 'text-red-500'; };
            
            async function hashPassword(password) {
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            // --- Data & State Management ---
            const saveAppData = () => localStorage.setItem('multiUserWeightTracker', JSON.stringify(appData));
            const loadAppData = () => { appData = JSON.parse(localStorage.getItem('multiUserWeightTracker')) || { profiles: {}, lastActiveProfile: null }; activeProfile = appData.lastActiveProfile; };
            const loadProfileData = (profileName) => {
                const profile = appData.profiles[profileName];
                if (!profile) return;
                activeProfile = profileName;
                appData.lastActiveProfile = profileName;
                weightData = profile.weightData || []; goalWeight = profile.goalWeight; height = profile.height; units = profile.units || 'kg';
                allDOMElements.currentProfileName.textContent = profileName;
                allDOMElements.mainContent.classList.remove('opacity-20', 'pointer-events-none');
                render();
            };
            const saveCurrentProfileData = () => { if (activeProfile) { appData.profiles[activeProfile] = { ...appData.profiles[activeProfile], weightData, goalWeight, height, units }; saveAppData(); } };
            const lockUI = () => { allDOMElements.mainContent.classList.add('opacity-20', 'pointer-events-none'); allDOMElements.currentProfileName.textContent = "Locked"; };
            
            // --- Rendering Functions ---
            const render = () => { if (!activeProfile) return; updateUnitToggleUI(); renderStats(); renderHistory(); renderChart(); saveCurrentProfileData(); };
            const renderProfileSwitcher = () => {
                allDOMElements.profileList.innerHTML = '';
                Object.keys(appData.profiles).forEach(name => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100';
                    if (name === activeProfile) item.classList.add('font-bold', 'bg-slate-100');
                    item.textContent = name;
                    item.dataset.profileName = name;
                    item.addEventListener('click', (e) => { e.preventDefault(); handleProfileSwitch(name); });
                    allDOMElements.profileList.appendChild(item);
                });
            };
            const renderManageProfiles = () => {
                allDOMElements.manageProfileList.innerHTML = '';
                Object.keys(appData.profiles).forEach(name => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-2 border rounded-lg';
                    div.innerHTML = `
                        <span class="font-medium">${name}</span>
                        <div class="flex gap-2">
                            <button data-name="${name}" class="rename-profile-btn bg-blue-100 text-blue-700 px-3 py-1 rounded-md text-xs hover:bg-blue-200">Rename</button>
                            <button data-name="${name}" class="delete-profile-btn bg-red-100 text-red-700 px-3 py-1 rounded-md text-xs hover:bg-red-200">Delete</button>
                        </div>
                    `;
                    allDOMElements.manageProfileList.appendChild(div);
                });
            };

            const toggleModal = (modal, show) => modal.classList.toggle('hidden', !show) || modal.classList.toggle('flex', show);
            const updateUnitToggleUI = () => { allDOMElements.inputUnitLabel.textContent = units; allDOMElements.unitKgBtn.classList.toggle('bg-blue-600', units === 'kg'); allDOMElements.unitKgBtn.classList.toggle('text-white', units === 'kg'); allDOMElements.unitLbsBtn.classList.toggle('bg-blue-600', units === 'lbs'); allDOMElements.unitLbsBtn.classList.toggle('text-white', units === 'lbs'); };
            const renderStats = () => { /* Unchanged from previous version */ allDOMElements.goalWeightEl.textContent = goalWeight ? formatWeight(goalWeight) : '--'; if (weightData.length > 0) { weightData.sort((a, b) => new Date(a.date) - new Date(b.date)); const firstEntry = weightData[0]; const latestEntry = weightData[weightData.length - 1]; const change = latestEntry.weight - firstEntry.weight; allDOMElements.currentWeightEl.textContent = formatWeight(latestEntry.weight); const formattedChange = formatWeight(Math.abs(change)); allDOMElements.weightChangeEl.textContent = `${change >= 0 ? '+' : ''}${formattedChange.split(' ')[0]} ${units}`; allDOMElements.weightChangeEl.className = 'text-xl font-bold p-1 rounded-md'; if (change > 0.05) allDOMElements.weightChangeEl.classList.add('text-red-600'); else if (change < -0.05) allDOMElements.weightChangeEl.classList.add('text-green-600'); else allDOMElements.weightChangeEl.classList.add('text-slate-900'); const bmi = calculateBMI(latestEntry.weight, height); allDOMElements.bmiStatEl.textContent = bmi; allDOMElements.bmiStatEl.className = `text-xl font-bold p-1 rounded-md ${getBmiColor(bmi)}`; const now = Date.now(); const weeklyData = weightData.filter(d => new Date(d.date).getTime() >= now - 7 * 86400000); const monthlyData = weightData.filter(d => new Date(d.date).getTime() >= now - 30 * 86400000); allDOMElements.weeklyAvgEl.textContent = weeklyData.length > 0 ? formatWeight(weeklyData.reduce((s, c) => s + c.weight, 0) / weeklyData.length) : '--'; allDOMElements.monthlyAvgEl.textContent = monthlyData.length > 0 ? formatWeight(monthlyData.reduce((s, c) => s + c.weight, 0) / monthlyData.length) : '--'; const allWeights = weightData.map(d => d.weight); allDOMElements.lowestWeightStatEl.textContent = formatWeight(Math.min(...allWeights)); allDOMElements.highestWeightStatEl.textContent = formatWeight(Math.max(...allWeights)); if (goalWeight && firstEntry) { const start = firstEntry.weight; const current = latestEntry.weight; const goal = goalWeight; const totalDistance = Math.abs(start - goal); const traveledDistance = start - current; let progress = totalDistance > 0 ? (traveledDistance / (start - goal)) * 100 : (current <= goal ? 100 : 0); progress = Math.max(0, Math.min(100, progress)); allDOMElements.goalProgressBar.style.width = `${progress}%`; } } else { ['current-weight', 'goal-weight', 'weight-change', 'bmi-stat', 'weekly-avg-stat', 'monthly-avg-stat', 'lowest-weight-stat', 'highest-weight-stat'].forEach(id => document.getElementById(id).textContent = '--'); allDOMElements.goalProgressBar.style.width = '0%'; } };
            const renderHistory = () => { /* Unchanged from previous version */ const hasData = weightData.length > 0; allDOMElements.historyContainer.classList.toggle('hidden', !hasData); allDOMElements.historyEmptyState.classList.toggle('hidden', hasData); allDOMElements.historyEmptyState.classList.toggle('flex', !hasData); if (!hasData) return; allDOMElements.historyBody.innerHTML = ''; [...weightData].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((entry, index) => { const row = document.createElement('tr'); row.className = 'border-b border-slate-200 hover:bg-slate-50'; if (index === 0) row.classList.add('new-entry-animation'); const formattedDate = new Date(entry.date).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }); row.innerHTML = `<td class="py-3 px-4">${formattedDate}</td><td class="py-3 px-4 font-medium">${formatWeight(entry.weight)}</td><td class="py-3 px-4 text-slate-500 italic truncate" title="${entry.note || ''}">${entry.note || ''}</td><td class="py-3 px-4 text-right"><button class="delete-btn text-slate-400 hover:text-red-500" data-id="${entry.id}"><svg class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></td>`; allDOMElements.historyBody.appendChild(row); }); };
            const renderChart = () => { /* Unchanged from previous version */ const hasData = weightData.length > 0; allDOMElements.chartCanvas.classList.toggle('hidden', !hasData); allDOMElements.chartEmptyState.classList.toggle('hidden', hasData); allDOMElements.chartEmptyState.classList.toggle('flex', !hasData); if (!hasData) { if(weightChart) weightChart.destroy(); weightChart = null; return; } const dataPoints = weightData.map(d => ({ x: new Date(d.date), y: convertFromKg(d.weight) })); const trendData = []; if (weightData.length >= 7) { for (let i = 6; i < weightData.length; i++) { let sum = 0; for (let j = 0; j < 7; j++) sum += weightData[i - j].weight; trendData.push({ x: new Date(weightData[i].date), y: convertFromKg(sum / 7) }); } } const datasets = [{ label: `Weight (${units})`, data: dataPoints, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.2, pointRadius: 4 }]; if (trendData.length > 0) datasets.push({ label: '7-Day Trend', data: trendData, borderColor: '#f97316', fill: false, pointRadius: 0, borderWidth: 2 }); if (goalWeight && dataPoints.length > 0) datasets.push({ label: `Goal (${units})`, data: dataPoints.map(d => ({ x: d.x, y: convertFromKg(goalWeight) })), borderColor: '#10b981', borderDash: [5, 5], fill: false, pointRadius: 0 }); if (weightChart) { weightChart.data.datasets = datasets; weightChart.update(); } else { weightChart = new Chart(allDOMElements.chartCanvas, { type: 'line', data: { datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM d, hh:mm a' } }, y: { ticks: { callback: value => `${value.toFixed(1)} ${units}` } } }, plugins: { tooltip: { callbacks: { label: context => `Weight: ${context.parsed.y.toFixed(1)} ${units}`, afterBody: (items) => weightData[items[0].dataIndex]?.note || '' } } } } }); } };
            
            // --- Event Handlers ---
            const handleProfileSwitch = (profileName) => {
                if (profileName === activeProfile) return;
                const profile = appData.profiles[profileName];
                if (profile.passwordHash) {
                    profileToLogin = profileName;
                    allDOMElements.loginProfileName.textContent = profileName;
                    toggleModal(allDOMElements.loginModal, true);
                    allDOMElements.loginPasswordInput.focus();
                } else {
                    loadProfileData(profileName);
                }
            };
            
            const handleLogin = async () => {
                const password = allDOMElements.loginPasswordInput.value;
                if (!password || !profileToLogin) return;
                const hash = await hashPassword(password);
                if (hash === appData.profiles[profileToLogin].passwordHash) {
                    toggleModal(allDOMElements.loginModal, false);
                    allDOMElements.loginPasswordInput.value = '';
                    loadProfileData(profileToLogin);
                    profileToLogin = null;
                } else {
                    alert('Incorrect password.');
                }
            };

            const handleLogWeight = () => { /* Unchanged from previous version */ if (!activeProfile) return alert('Please select or create a profile first.'); const weightVal = parseFloat(allDOMElements.weightInput.value); if (!weightVal || weightVal <= 0) return alert('Please enter a valid weight.'); const previousLowest = weightData.length > 0 ? Math.min(...weightData.map(d => d.weight)) : Infinity; const weightInKg = convertToKg(weightVal); weightData.push({ id: Date.now(), date: new Date().toISOString(), weight: weightInKg, note: allDOMElements.notesInput.value.trim() }); allDOMElements.weightInput.value = ''; allDOMElements.notesInput.value = ''; ['current-weight', 'weight-change', 'bmi-stat', 'weekly-avg-stat', 'monthly-avg-stat'].forEach(id => { const el = document.getElementById(id).parentElement; el.classList.add('flash-update'); setTimeout(() => el.classList.remove('flash-update'), 800); }); render(); if (weightInKg <= goalWeight) confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } }); else if (weightInKg < previousLowest) confetti({ particleCount: 100, spread: 70, origin: { y: 0.7 }, angle: 270, colors: ['#2563eb', '#ffffff'] }); };
            const handleCreateProfile = async () => {
                const name = allDOMElements.profileInput.value.trim();
                const pass = allDOMElements.profilePasswordInput.value;
                const confirmPass = allDOMElements.profileConfirmPasswordInput.value;
                if (!name) return alert('Please enter a profile name.');
                if (appData.profiles[name]) return alert('Profile name already exists.');
                if (pass.length < 4) return alert('Password must be at least 4 characters long.');
                if (pass !== confirmPass) return alert('Passwords do not match.');
                
                const passwordHash = await hashPassword(pass);
                appData.profiles[name] = { weightData: [], units: 'kg', passwordHash };
                toggleModal(allDOMElements.profileModal, false);
                allDOMElements.profileInput.value = ''; allDOMElements.profilePasswordInput.value = ''; allDOMElements.profileConfirmPasswordInput.value = '';
                renderProfileSwitcher();
                loadProfileData(name);
                toggleModal(allDOMElements.heightModal, true);
            };

            const handleManageProfiles = (e) => {
                const target = e.target;
                const profileName = target.dataset.name;
                if (target.classList.contains('rename-profile-btn')) {
                    const newName = prompt(`Enter new name for "${profileName}":`, profileName);
                    if (newName && newName.trim() && !appData.profiles[newName.trim()]) {
                        const newPassword = prompt(`Enter new password for "${newName.trim()}" (leave blank to keep old one):`);
                        if (newPassword === null) return; // User cancelled
                        
                        const profileData = appData.profiles[profileName];
                        delete appData.profiles[profileName];
                        
                        if (newPassword) {
                            hashPassword(newPassword).then(hash => {
                                profileData.passwordHash = hash;
                                appData.profiles[newName.trim()] = profileData;
                                if (activeProfile === profileName) activeProfile = newName.trim();
                                saveAppData();
                                renderProfileSwitcher();
                                renderManageProfiles();
                            });
                        } else {
                            appData.profiles[newName.trim()] = profileData;
                            if (activeProfile === profileName) activeProfile = newName.trim();
                            saveAppData();
                            renderProfileSwitcher();
                            renderManageProfiles();
                        }
                    } else if (newName) {
                        alert('Invalid or duplicate profile name.');
                    }
                } else if (target.classList.contains('delete-profile-btn')) {
                    if (confirm(`Are you sure you want to delete profile "${profileName}"? All data will be lost.`)) {
                        delete appData.profiles[profileName];
                        if (activeProfile === profileName) {
                            activeProfile = null;
                            lockUI();
                        }
                        saveAppData();
                        renderProfileSwitcher();
                        renderManageProfiles();
                        if (!activeProfile) {
                            const remainingProfiles = Object.keys(appData.profiles);
                            if (remainingProfiles.length > 0) {
                                handleProfileSwitch(remainingProfiles[0]);
                            } else {
                                toggleModal(allDOMElements.profileModal, true);
                            }
                        }
                    }
                }
            };

            const handleSetGoal = () => { /* Unchanged */ const val = parseFloat(allDOMElements.goalInput.value); if (!val || val <= 0) return; goalWeight = convertToKg(val); toggleModal(allDOMElements.goalModal, false); render(); };
            const handleSetHeight = () => { /* Unchanged */ const val = parseFloat(allDOMElements.heightInput.value); if (!val || val <= 0) return; height = val / 100; toggleModal(allDOMElements.heightModal, false); render(); };
            const handleDeleteEntry = (e) => { /* Unchanged */ if (e.target.closest('.delete-btn')) { entryToDelete = parseInt(e.target.closest('.delete-btn').dataset.id); toggleModal(allDOMElements.deleteConfirmModal, true); } };
            const confirmDelete = () => { /* Unchanged */ if (entryToDelete !== null) { weightData = weightData.filter(entry => entry.id !== entryToDelete); entryToDelete = null; toggleModal(allDOMElements.deleteConfirmModal, false); render(); } };
            const handleExport = () => { /* Unchanged */ if (!activeProfile) return; const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData, null, 2)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", `weight_tracker_all_profiles.json`); dl.click(); };
            const handleImport = (e) => { /* Unchanged */ const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const imported = JSON.parse(event.target.result); if (confirm("This will overwrite ALL profiles. Are you sure?")) { appData = imported; activeProfile = appData.lastActiveProfile; renderProfileSwitcher(); loadProfileData(activeProfile); } } catch (error) { alert("Error reading file."); } }; reader.readAsText(file); e.target.value = null; };

            // --- Initialization ---
            const init = () => {
                loadAppData();
                if (!activeProfile && Object.keys(appData.profiles).length > 0) {
                    activeProfile = Object.keys(appData.profiles)[0];
                }

                if (!activeProfile) {
                    toggleModal(allDOMElements.profileModal, true);
                } else {
                    renderProfileSwitcher();
                    handleProfileSwitch(activeProfile);
                    if (appData.profiles[activeProfile] && goalWeight === undefined) toggleModal(allDOMElements.goalModal, true);
                    else if (appData.profiles[activeProfile] && height === undefined) toggleModal(allDOMElements.heightModal, true);
                }
                
                allDOMElements.logBtn.addEventListener('click', handleLogWeight);
                allDOMElements.createProfileBtn.addEventListener('click', handleCreateProfile);
                allDOMElements.addProfileBtn.addEventListener('click', () => toggleModal(allDOMElements.profileModal, true));
                allDOMElements.manageProfilesBtn.addEventListener('click', () => { renderManageProfiles(); toggleModal(allDOMElements.manageProfilesModal, true); });
                allDOMElements.closeManageProfilesBtn.addEventListener('click', () => toggleModal(allDOMElements.manageProfilesModal, false));
                allDOMElements.manageProfileList.addEventListener('click', handleManageProfiles);
                allDOMElements.loginBtn.addEventListener('click', handleLogin);
                allDOMElements.setGoalBtn.addEventListener('click', handleSetGoal);
                allDOMElements.setHeightBtn.addEventListener('click', handleSetHeight);
                allDOMElements.editGoalBtn.addEventListener('click', () => { allDOMElements.goalInput.value = goalWeight ? convertFromKg(goalWeight).toFixed(1) : ''; toggleModal(allDOMElements.goalModal, true); });
                allDOMElements.editHeightBtn.addEventListener('click', () => { allDOMElements.heightInput.value = height ? (height * 100).toFixed(0) : ''; toggleModal(allDOMElements.heightModal, true); });
                allDOMElements.historyBody.addEventListener('click', handleDeleteEntry);
                allDOMElements.unitKgBtn.addEventListener('click', () => { if (units !== 'kg') { units = 'kg'; render(); } });
                allDOMElements.unitLbsBtn.addEventListener('click', () => { if (units !== 'lbs') { units = 'lbs'; render(); } });
                allDOMElements.exportBtn.addEventListener('click', handleExport);
                allDOMElements.importBtn.addEventListener('click', () => allDOMElements.importFile.click());
                allDOMElements.importFile.addEventListener('change', handleImport);
                allDOMElements.confirmDeleteBtn.addEventListener('click', confirmDelete);
                allDOMElements.cancelDeleteBtn.addEventListener('click', () => toggleModal(allDOMElements.deleteConfirmModal, false));
                allDOMElements.weightInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleLogWeight());
                allDOMElements.loginPasswordInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleLogin());
            };

            init();
        });
    </script>
</body>
</html>
